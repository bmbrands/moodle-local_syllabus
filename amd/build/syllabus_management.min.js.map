{"version":3,"sources":["../src/syllabus_management.js"],"names":["define","$","Ajax","Str","Notification","SortableList","init","sortwloc","moveHandlerSelector","locationName","element","closest","attr","displayNoElementIfNeeded","evt","stopPropagation","get_string","then","s","children","each","fields","find","nofields","length","append","remove","fail","exception","dropIntoList","info","positionChanged","fieldid","data","location","targetList","beforeid","targetNextElement","promises","call","methodname","args","getDestinationName","parentElement","afterElement","Deferred","resolve","on","setTimeout","width","e","window","reload","preventDefault"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A javascript module to retrieve a course list from the server.\n *\n * @package    local_resourcelibrary\n * @copyright  2020 CALL Learning 2020 - Laurent David laurent@call-learning.fr\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'core/str', 'core/notification', 'core/sortable_list'],\n    function ($,\n              Ajax,\n              Str,\n              Notification,\n              SortableList\n              ) {\n        return {\n            init: function () {\n                // Sort fields who already have a location.\n                var sortwloc = new SortableList(\n                    $('#syllabus-management .location-list tbody'),\n                    {moveHandlerSelector: '.movefield [data-drag-type=move]'}\n                );\n                var locationName = function (element) {\n                    return element\n                        .closest('[data-location-id]')\n                        .attr('data-value');\n                };\n                var displayNoElementIfNeeded = function (evt) {\n                    evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n                    // Refreshing fields tables.\n                    Str.get_string('therearenofields', 'core_customfield').then(function (s) {\n                        $('#syllabus-management .location-list').children().each(function () {\n                            var fields = $(this).find($('.field')),\n                                nofields = $(this).find($('.nofields'));\n                            if (!fields.length && !nofields.length) {\n                                $(this).find('tbody').append(\n                                    '<tr class=\"nofields\"><td colspan=\"5\">' + s + '</td></tr>'\n                                );\n                            }\n                            if (fields.length && nofields.length) {\n                                nofields.remove();\n                            }\n                        });\n                        return null;\n                    }).fail(Notification.exception);\n                };\n\n                var dropIntoList = function (evt, info) {\n                    evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n                    if (info.positionChanged) {\n                        const fieldid = info.element.data('field-id');\n                        const location = info.targetList.closest('[data-location-id]').attr('data-location-id');\n                        var beforeid = info.targetNextElement.data('field-id');\n                        var promises = Ajax.call([\n                            {\n                                methodname: 'local_syllabus_move_field_to_location',\n                                args: {\n                                    fieldid: fieldid,\n                                    location: location,\n                                    beforeid: beforeid\n                                },\n                            },\n                        ]);\n                        promises[0].fail(Notification.exception);\n                    }\n                };\n\n                sortwloc.getDestinationName = function (parentElement, afterElement) {\n                    if (!afterElement.length) {\n                        return Str.get_string('totopofcategory', 'local_syllabus', locationName(parentElement));\n                    } else if (afterElement.attr('data-field-name')) {\n                        return Str.get_string('afterfield', 'local_syllabus', afterElement.attr('data-field-name'));\n                    } else {\n                        return $.Deferred().resolve('');\n                    }\n                };\n\n                $('[data-field-name]').on('sortablelist-drop', function (evt, info) {\n                    dropIntoList(evt, info);\n                }).on('sortablelist-drag', function (evt) {\n                    displayNoElementIfNeeded(evt);\n                });\n\n                $('[data-field-name]').on('sortablelist-dragstart',\n                    function (evt, info) {\n                        setTimeout(function () {\n                            $('.sortable-list-is-dragged').width(info.element.width());\n                        }, 501);\n                    }\n                );\n                $(\"[data-role=removefield]\").on('click', function(e) {\n                    const fieldid = $(this).attr('data-id');\n                    Ajax.call([\n                        {\n                            methodname: 'local_syllabus_move_field_to_location',\n                            args: {\n                                fieldid: fieldid,\n                                location: 'none',\n                                beforeid: 0\n                            },\n                        }\n                    ])[0].then(function() {\n                        window.location.reload();\n                    }).fail(Notification.exception);\n                    e.preventDefault();\n                });\n            },\n        };\n    });\n"],"file":"syllabus_management.min.js"}